<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Localstorage eventlistener</title><meta property="iterate_uuid" content="a39fc5cc-77a4-4756-8674-a69f3ed733db"/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/1e1a8d2e68ab27a8.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1e1a8d2e68ab27a8.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-59c5c889f52620d6.js" defer=""></script><script src="/_next/static/chunks/framework-114634acb84f8baa.js" defer=""></script><script src="/_next/static/chunks/main-010ff0b6bbe5ac8f.js" defer=""></script><script src="/_next/static/chunks/pages/_app-6575b9a009c08b17.js" defer=""></script><script src="/_next/static/chunks/996-c5e5aa4c30f33066.js" defer=""></script><script src="/_next/static/chunks/874-2bda5c2657e2fd55.js" defer=""></script><script src="/_next/static/chunks/887-0da152cb228ec2fb.js" defer=""></script><script src="/_next/static/chunks/pages/post/%5Bslug%5D-a2ebf61450f06fc0.js" defer=""></script><script src="/_next/static/EFLsK_tY0a_KvU_iVAZh1/_buildManifest.js" defer=""></script><script src="/_next/static/EFLsK_tY0a_KvU_iVAZh1/_ssgManifest.js" defer=""></script></head><body><div id="__next"><main><h1>Localstorage eventlistener</h1><p>Jeg har lyst til å vise frem et kult web-api som heter <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/storage_event">storage event</a>. Dette eventet er ganske nifty om man lager en stateful app der det forventes at brukere har mange faner oppe samtidig og ønsker å bevare state mellom dem. Man lytter på storage på denne måten:</p><pre class="refractor language-ts"><code class="language-ts"> window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;storage&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;The storage has changed: &quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>Minner om <a href="https://developer.mozilla.org/en-US/docs/Web/API/Storage/setItem">funksjonene</a> </p><pre class="refractor language-ts"><code class="language-ts"><span class="token comment">//getItem</span>
window<span class="token punctuation">.</span>localstorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
<span class="token comment">//setItem</span>
window<span class="token punctuation">.</span>localstorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span></code></pre><p>setItem skriver en <strong>tekststreng</strong> til localstorage, og getItem henter en <strong>tekststreng</strong>. </p><p>Prøv gjerne selv i en javascript konsoll nær deg:</p><pre class="refractor language-ts"><code class="language-ts"><span class="token comment">// Legg inn todos i localstorage</span>
window<span class="token punctuation">.</span>localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">&quot;todos&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> todos<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Lag en funksjon som henter todos fra localstorage</span>
<span class="token keyword">function</span> <span class="token function">getTodos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> todos <span class="token operator">=</span> window<span class="token punctuation">.</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">&quot;todos&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>todos <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>todos<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token string">&quot;no todolist stored&quot;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Kall funksjonen</span>
<span class="token keyword">const</span> todos <span class="token operator">=</span> <span class="token function">getTodos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Se på resultatet</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;todos&quot;</span><span class="token punctuation">,</span> todos<span class="token punctuation">)</span></code></pre><h2>Eksempel med react-query og next</h2><p>For å vise hvordan dette kan brukes lager jeg en enkel todoliste som er synket over flere tabs. Jeg gjør det i react, med <a href="https://tanstack.com/query/v4/docs/react/overview">react-query</a> og <a href="https://nextjs.org/docs/getting-started">next</a> men storage er et web api og kan brukes hvor som helst. React-query gjør det lett å invalidere state basert på localstorage endringer, også er det en del som bruker next for tida.</p><p>Først lager vi en query i en utility fil, f.eks i /queries/todoQuery.ts :</p><pre class="refractor language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">useTodos</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">useQuery</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;todos&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fetchTodos<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>fetchTodos kommer nå til å være en funksjon vi skriver mot localstorage heller enn mot et endepunkt på nett. Og den ligner veldig på getTodos.</p><pre class="refractor language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">fetchTodos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Todos<span class="token operator">&gt;</span></code></pre><p>Vi lager typen Todos, vi gir todos en unik id fordi beskrivelser ikke nødvendigvis er unike ved å gi den en uuid.</p><pre class="refractor language-ts"><code class="language-ts"><span class="token keyword">type</span> <span class="token class-name">Todos</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  items<span class="token operator">:</span> Todo<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token class-name">Todo</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  description<span class="token operator">:</span> String<span class="token punctuation">;</span>
  done<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  id<span class="token operator">:</span> String<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="refractor language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">fetchTodos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Todos<span class="token operator">&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> storageResult <span class="token operator">=</span> window<span class="token punctuation">.</span>localstorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">&quot;todos&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>storageResult <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> todos<span class="token operator">:</span> Todos <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>storageResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>todos<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>items<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><p>Merk at storageResult kan se annerledes ut enn vi tror, finnes til og med brukere som går inn der og trykker litt 🙈så her an et være greit å gjøre noen sjekker på at dataen er på formatet man forventer før man kjører resolve.</p><p>Legg også merke til at når vi ikke finner todos velger vi å returnere en tom liste sånn at vi alltid har todos på et kjent format. Senere vil vi ofte heller ha tom liste enn undefined.</p><p>Funksjonene for å slette/endre/legge følger mønsteret med å hente ut, lage en kopi av lista, endre, skrive tilbake. Vi bruker queryclient for å invalidere queryen vår sånn at prosessen vi er i skal oppdateres. Localstorage eventlistener vil sørge for at alle andre prosesser får en melding senere.</p><pre class="refractor language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> v4 <span class="token keyword">as</span> uuidv4 <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;uuid&#x27;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">addItemToTodo</span> <span class="token operator">=</span> <span class="token punctuation">(</span>item<span class="token operator">:</span> Todo<span class="token punctuation">,</span> queryClient<span class="token operator">:</span> QueryClient<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> storageResult <span class="token operator">=</span> window<span class="token punctuation">.</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">&quot;todos&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> newTodo <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>item<span class="token punctuation">,</span>
    id<span class="token operator">:</span> <span class="token function">uuidv4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>storageResult <span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> oldTodos<span class="token operator">:</span> Todos <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>storageResultult<span class="token punctuation">)</span>
    <span class="token keyword">const</span> newItems <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>oldTodos<span class="token punctuation">.</span>items<span class="token punctuation">,</span> newTodo<span class="token punctuation">]</span>
    window<span class="token punctuation">.</span>localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">&quot;todos&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      items<span class="token operator">:</span> newItems
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">&quot;todos&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      items<span class="token operator">:</span> <span class="token punctuation">[</span>newTodo<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  queryClient<span class="token punctuation">.</span><span class="token function">invalidateQueries</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;todos&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="refractor language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">removeItemFromTodo</span> <span class="token operator">=</span> <span class="token punctuation">(</span>id<span class="token operator">:</span> String<span class="token punctuation">,</span> queryClient<span class="token operator">:</span> QueryClient<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> storageResult <span class="token operator">=</span> window<span class="token punctuation">.</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">&quot;todos&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>storageResult <span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token keyword">const</span> oldTodos<span class="token operator">:</span> Todos <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>storageResult<span class="token punctuation">)</span>
     <span class="token keyword">const</span> newItems <span class="token operator">=</span> oldtTodos<span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>id <span class="token operator">!=</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token boolean">true</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token boolean">false</span>
       <span class="token punctuation">}</span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span>
     window<span class="token punctuation">.</span>localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">&quot;todos&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>items<span class="token operator">:</span> newItems<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
     <span class="token comment">// We should not have the ability to remove from an empty list so here we can throw an error of our own choosing</span>
     <span class="token keyword">return</span>
   <span class="token punctuation">}</span>
   queryClient<span class="token punctuation">.</span><span class="token function">invalidateQueries</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;todos&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="refractor language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">toggleTodo</span> <span class="token operator">=</span> <span class="token punctuation">(</span>id<span class="token operator">:</span> String<span class="token punctuation">,</span> queryClient<span class="token operator">:</span> QueryClient<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> storageResult <span class="token operator">=</span> window<span class="token punctuation">.</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">&quot;todos&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>storageResult <span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token keyword">const</span> oldTodos<span class="token operator">:</span> Todos <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>storageResult<span class="token punctuation">)</span>
     <span class="token keyword">const</span> changeIndex <span class="token operator">=</span> oldTodos<span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>id <span class="token operator">==</span> id<span class="token punctuation">)</span>
     <span class="token keyword">const</span> newItems <span class="token operator">=</span> <span class="token punctuation">[</span>
       <span class="token operator">...</span>oldTodos<span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> cangeIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">{</span>
         <span class="token operator">...</span>oldTodos<span class="token punctuation">.</span>items<span class="token punctuation">[</span>changeIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> 
         done<span class="token operator">:</span> <span class="token operator">!</span>oldTodos<span class="token punctuation">.</span>items<span class="token punctuation">[</span>changeIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>done
       <span class="token punctuation">}</span>
       <span class="token operator">...</span>oldTodos<span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>changeIndex<span class="token punctuation">)</span>
       <span class="token punctuation">]</span>
     window<span class="token punctuation">.</span>localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">&quot;todos&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>items<span class="token operator">:</span> newItems<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
     <span class="token comment">// We should not have the ability to set done from an empty list so here we can throw an error our own choosing</span>
     <span class="token keyword">return</span>
   <span class="token punctuation">}</span>
  queryClient<span class="token punctuation">.</span><span class="token function">invalidateQueries</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;todos&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Til slutt må vi invalidere queryen vår når localstorage endres. Nextjs skiller mellom _document og _app.  Vi trenger en <a href="https://nextjs.org/docs/advanced-features/custom-app">custom app</a> </p><pre class="refractor language-ts"><code class="language-ts"><span class="token comment">// _app.tsx</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  QueryClient<span class="token punctuation">,</span>
  QueryClientProvider<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@tanstack/react-query&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">MyApp</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> Component<span class="token punctuation">,</span> pageProps <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>queryClient<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">QueryClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// window er undefined på serverside</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> window <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;storage&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> todos <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">&quot;todos&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>todos <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        queryClient<span class="token punctuation">.</span><span class="token function">invalidateQueries</span><span class="token punctuation">(</span><span class="token string">&quot;todos&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
 <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>QueryClientProvider client<span class="token operator">=</span><span class="token punctuation">{</span>queryClient<span class="token punctuation">}</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>Component <span class="token punctuation">{</span><span class="token operator">...</span>pageProps<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>QueryClientProvider<span class="token operator">&gt;</span>
   <span class="token punctuation">)</span> 
<span class="token punctuation">}</span></code></pre><p>Alt som gjenstår nå er å bruke queryen vår</p><pre class="refractor language-ts"><code class="language-ts"><span class="token comment">// file: todo.tsx</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>useState<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  addItemToTodo<span class="token punctuation">,</span>
  removeItemFromTodo<span class="token punctuation">,</span>
  toggleTodo<span class="token punctuation">,</span>
  useTodos<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;todoQuery&quot;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useQueryClient <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@tanstack/react-query&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">TodoComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> todos <span class="token operator">=</span> <span class="token function">useTodos</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>addTodo<span class="token punctuation">,</span> setAddTodo<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useState</span><span class="token generic class-name"><span class="token operator">&lt;</span>String<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">const</span> queryClient <span class="token operator">=</span> <span class="token function">useQueryClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>todos<span class="token punctuation">.</span>isSuccess<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token operator">&lt;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span><span class="token constant">MY</span> <span class="token constant">TODOS</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">&quot;text&quot;</span> value<span class="token operator">=</span><span class="token punctuation">{</span>addTodo<span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setAddTodo</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">addItemToTodo</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span>
          description<span class="token operator">:</span> addTodo<span class="token punctuation">,</span>
          done<span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> queryClient<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>Add the todo<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>ul<span class="token operator">&gt;</span>
      todos<span class="token punctuation">.</span>data<span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>todo <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span>
          <span class="token punctuation">{</span>todo<span class="token punctuation">.</span>description<span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">&quot; &quot;</span><span class="token punctuation">}</span>
          <span class="token punctuation">{</span>todo<span class="token punctuation">.</span>done <span class="token operator">?</span> <span class="token string">&quot;done&quot;</span><span class="token operator">:</span> <span class="token string">&quot;not done&quot;</span><span class="token punctuation">}</span>
          <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">toggleTodo</span><span class="token punctuation">(</span>todo<span class="token punctuation">.</span>id<span class="token punctuation">,</span> queryClient<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>toggle todo<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>buttononClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">removeItemFromTodo</span><span class="token punctuation">(</span>todo<span class="token punctuation">.</span>id<span class="token punctuation">,</span> queryClient<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>remove todo <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>Laster inn <span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Queryen fungerer nå på tvers av faner!!!</p></main><h2>Written by/skrevet av</h2><h3>Finn Inderhaug Holme</h3><img src="https://cdn.sanity.io/images/6yo33vbl/prod/e34a422971d05a7ed927158b762679e4fd178e7c-800x1000.jpg" alt=""/><ul><li><a href="https://iterate.no">https://iterate.no</a></li></ul><h2>Cudoz/Inspirasjon til</h2><h3>Carlo Morte</h3><img src="https://cdn.sanity.io/images/6yo33vbl/prod/0ecb68d017f70ab26cde2f8642dfd8072944ab10-516x518.png" alt=""/><ul><li><a href="https://no.linkedin.com/in/carlo-morte-92a687131">https://no.linkedin.com/in/carlo-morte-92a687131</a></li></ul></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"blog":{"authors":[{"image":{"_type":"image","asset":{"_ref":"image-e34a422971d05a7ed927158b762679e4fd178e7c-800x1000-jpg","_type":"reference"}},"links":["https://iterate.no"],"name":"Finn Inderhaug Holme"}],"content":[{"_key":"f1bd04148609","_type":"block","children":[{"_key":"9e59fde39762","_type":"span","marks":[],"text":"Jeg har lyst til å vise frem et kult web-api som heter "},{"_key":"69cbb45e215f","_type":"span","marks":["f24bc507fc8f"],"text":"storage event"},{"_key":"c0ceb95697e6","_type":"span","marks":[],"text":". Dette eventet er ganske nifty om man lager en stateful app der det forventes at brukere har mange faner oppe samtidig og ønsker å bevare state mellom dem. Man lytter på storage på denne måten:"}],"markDefs":[{"_key":"f24bc507fc8f","_type":"link","href":"https://developer.mozilla.org/en-US/docs/Web/API/Window/storage_event"}],"style":"normal"},{"_key":"8c2ed9a00328","_type":"code","code":" window.addEventListener(\"storage\", (e) =\u003e {\n   console.log(\"The storage has changed: \", e)\n })","language":"typescript"},{"_key":"89cd68a01e3f","_type":"block","children":[{"_key":"4f5175aba448","_type":"span","marks":[],"text":"Minner om "},{"_key":"2b7b38f120fb","_type":"span","marks":["d568b8b7f3e6"],"text":"funksjonene"},{"_key":"85b44487c067","_type":"span","marks":[],"text":" "}],"markDefs":[{"_key":"d568b8b7f3e6","_type":"link","href":"https://developer.mozilla.org/en-US/docs/Web/API/Storage/setItem"}],"style":"normal"},{"_key":"c2935b65f942","_type":"code","code":"//getItem\nwindow.localstorage.getItem(key)\n//setItem\nwindow.localstorage.setItem(key, value)","language":"typescript"},{"_key":"b30a4c4672e3","_type":"block","children":[{"_key":"4f94b504fece","_type":"span","marks":[],"text":"setItem skriver en "},{"_key":"62be5dd05455","_type":"span","marks":["strong"],"text":"tekststreng"},{"_key":"207709f125a4","_type":"span","marks":[],"text":" til localstorage, og getItem henter en "},{"_key":"34c8ed7026bd","_type":"span","marks":["strong"],"text":"tekststreng"},{"_key":"a47419ad76f8","_type":"span","marks":[],"text":". "}],"markDefs":[],"style":"normal"},{"_key":"90f183d1fa38","_type":"block","children":[{"_key":"4115f723134f","_type":"span","marks":[],"text":"Prøv gjerne selv i en javascript konsoll nær deg:"}],"markDefs":[],"style":"normal"},{"_key":"2a42c9d11a54","_type":"code","code":"// Legg inn todos i localstorage\nwindow.localStorage.setItem(\"todos\", JSON.stringify({ todos: [] }));\n\n// Lag en funksjon som henter todos fra localstorage\nfunction getTodos(){\n  const todos = window.localStorage.getItem(\"todos\");\n  if (todos !== null){\n    return JSON.parse(todos)\n  } else return \"no todolist stored\"\n}\n\n// Kall funksjonen\nconst todos = getTodos();\n// Se på resultatet\nconsole.log(\"todos\", todos)","language":"typescript"},{"_key":"75558be67d09","_type":"block","children":[{"_key":"a631e6ee650d","_type":"span","marks":[],"text":"Eksempel med react-query og next"}],"markDefs":[],"style":"h2"},{"_key":"9555b8a66d90","_type":"block","children":[{"_key":"f4c2ff024a64","_type":"span","marks":[],"text":"For å vise hvordan dette kan brukes lager jeg en enkel todoliste som er synket over flere tabs. Jeg gjør det i react, med "},{"_key":"4a25db180080","_type":"span","marks":["2f0253cd25f6"],"text":"react-query"},{"_key":"0d46e339314d","_type":"span","marks":[],"text":" og "},{"_key":"6239788bac31","_type":"span","marks":["f3fac24fefb5"],"text":"next"},{"_key":"a297813f641f","_type":"span","marks":[],"text":" men storage er et web api og kan brukes hvor som helst. React-query gjør det lett å invalidere state basert på localstorage endringer, også er det en del som bruker next for tida."}],"markDefs":[{"_key":"2f0253cd25f6","_type":"link","href":"https://tanstack.com/query/v4/docs/react/overview"},{"_key":"f3fac24fefb5","_type":"link","href":"https://nextjs.org/docs/getting-started"}],"style":"normal"},{"_key":"3a282a8c3385","_type":"block","children":[{"_key":"24c5a80a2fc3","_type":"span","marks":[],"text":"Først lager vi en query i en utility fil, f.eks i /queries/todoQuery.ts :"}],"markDefs":[],"style":"normal"},{"_key":"368c77b2cc62","_type":"code","code":"export const useTodos = () =\u003e useQuery([\"todos\"], fetchTodos);","language":"typescript"},{"_key":"6c05284a6374","_type":"block","children":[{"_key":"2d0b5cfa74e1","_type":"span","marks":[],"text":"fetchTodos kommer nå til å være en funksjon vi skriver mot localstorage heller enn mot et endepunkt på nett. Og den ligner veldig på getTodos."}],"markDefs":[],"style":"normal"},{"_key":"d8348c5c0cf4","_type":"code","code":"function fetchTodos(): Promise\u003cTodos\u003e","language":"typescript"},{"_key":"05f581b20228","_type":"block","children":[{"_key":"37e796ab2527","_type":"span","marks":[],"text":"Vi lager typen Todos, vi gir todos en unik id fordi beskrivelser ikke nødvendigvis er unike ved å gi den en uuid."}],"markDefs":[],"style":"normal"},{"_key":"c46fe562c98e","_type":"code","code":"type Todos = {\n  items: Todo[];\n}\n\ntype Todo = {\n  description: String;\n  done: boolean;\n  id: String;\n}","language":"typescript"},{"_key":"a727093957ab","_type":"code","code":"function fetchTodos(): Promise\u003cTodos\u003e{\n  return new Promise((resolve, reject) =\u003e {\n    try {\n      const storageResult = window.localstorage.getItem(\"todos\")\n      if (storageResult !== null){\n        let todos: Todos = JSON.parse(storageResult);\n        resolve(todos)\n      } else {\n        resolve({items: []})\n      }\n    } catch (err) {\n      reject(err)\n    }\n  })\n}","language":"typescript"},{"_key":"86c05620948a","_type":"block","children":[{"_key":"4dad87887251","_type":"span","marks":[],"text":"Merk at storageResult kan se annerledes ut enn vi tror, finnes til og med brukere som går inn der og trykker litt 🙈så her an et være greit å gjøre noen sjekker på at dataen er på formatet man forventer før man kjører resolve."}],"markDefs":[],"style":"normal"},{"_key":"1a5d88331a71","_type":"block","children":[{"_key":"1681bab9ea16","_type":"span","marks":[],"text":"Legg også merke til at når vi ikke finner todos velger vi å returnere en tom liste sånn at vi alltid har todos på et kjent format. Senere vil vi ofte heller ha tom liste enn undefined."}],"markDefs":[],"style":"normal"},{"_key":"cb0da0cd914a","_type":"block","children":[{"_key":"f5e1a8316155","_type":"span","marks":[],"text":"Funksjonene for å slette/endre/legge følger mønsteret med å hente ut, lage en kopi av lista, endre, skrive tilbake. Vi bruker queryclient for å invalidere queryen vår sånn at prosessen vi er i skal oppdateres. Localstorage eventlistener vil sørge for at alle andre prosesser får en melding senere."}],"markDefs":[],"style":"normal"},{"_key":"6efc15b72713","_type":"code","code":"import { v4 as uuidv4 } from 'uuid';\n\nexport const addItemToTodo = (item: Todo, queryClient: QueryClient) =\u003e {\n  const storageResult = window.localStorage.getItem(\"todos\")\n  const newTodo = {\n    ...item,\n    id: uuidv4()\n  }\n  if (storageResult !=null){\n    const oldTodos: Todos = JSON.parse(storageResultult)\n    const newItems = [...oldTodos.items, newTodo]\n    window.localStorage.setItem(\"todos\", JSON.stringify({\n      items: newItems\n    }))\n  } else {\n    window.localStorage.setItem(\"todos\", JSON.stringify({\n      items: [newTodo]\n    }))\n  }\n  queryClient.invalidateQueries([\"todos\"]);\n}","language":"typescript"},{"_key":"7c890c9990a2","_type":"code","code":"export const removeItemFromTodo = (id: String, queryClient: QueryClient) =\u003e {\n  const storageResult = window.localStorage.getItem(\"todos\")\n   if (storageResult !=null){\n     const oldTodos: Todos = JSON.parse(storageResult)\n     const newItems = oldtTodos.items.filter(item =\u003e {\n       if (item.id != id){\n         return true\n       } else {\n         return false\n       }\n     })\n     window.localStorage.setItem(\"todos\", JSON.stringify({items: newItems}))\n   } else {\n     // We should not have the ability to remove from an empty list so here we can throw an error of our own choosing\n     return\n   }\n   queryClient.invalidateQueries([\"todos\"]);\n}","language":"typescript"},{"_key":"c743da525366","_type":"code","code":"export const toggleTodo = (id: String, queryClient: QueryClient) =\u003e {\n  const storageResult = window.localStorage.getItem(\"todos\")\n   if (storageResult !=null){\n     const oldTodos: Todos = JSON.parse(storageResult)\n     const changeIndex = oldTodos.items.findIndex(item =\u003e item.id == id)\n     const newItems = [\n       ...oldTodos.items.splice(0, cangeIndex - 1),\n       {\n         ...oldTodos.items[changeIndex], \n         done: !oldTodos.items[changeIndex].done\n       }\n       ...oldTodos.items.splice(changeIndex)\n       ]\n     window.localStorage.setItem(\"todos\", JSON.stringify({items: newItems}))\n   } else {\n     // We should not have the ability to set done from an empty list so here we can throw an error our own choosing\n     return\n   }\n  queryClient.invalidateQueries([\"todos\"]);\n}","language":"typescript"},{"_key":"b20b3b9b6894","_type":"block","children":[{"_key":"2ff4b02c3f79","_type":"span","marks":[],"text":"Til slutt må vi invalidere queryen vår når localstorage endres. Nextjs skiller mellom _document og _app.  Vi trenger en "},{"_key":"75bd2395b49f","_type":"span","marks":["727ae57ca5ab"],"text":"custom app"},{"_key":"fda1f989fbdd","_type":"span","marks":[],"text":" "}],"markDefs":[{"_key":"727ae57ca5ab","_type":"link","href":"https://nextjs.org/docs/advanced-features/custom-app"}],"style":"normal"},{"_key":"0b10268d9cbe","_type":"code","code":"// _app.tsx\nimport {\n  QueryClient,\n  QueryClientProvider,\n} from \"@tanstack/react-query\";\n\nconst MyApp = ({ Component, pageProps }) =\u003e {\n  const [queryClient] = useState(() =\u003e new QueryClient());\n  // window er undefined på serverside\n  if (typeof window !== \"undefined\") {\n    window.addEventListener(\"storage\", () =\u003e {\n      const todos = JSON.parse(window.localStorage.getItem(\"todos\"));\n      if (todos !== null) {\n        queryClient.invalidateQueries(\"todos\");\n      }\n    });\n  }\n  \n return (\n    \u003cQueryClientProvider client={queryClient}\u003e\n      \u003cComponent {...pageProps} /\u003e\n    \u003c/QueryClientProvider\u003e\n   ) \n}","language":"typescript"},{"_key":"4d49f4430923","_type":"block","children":[{"_key":"32d6e36c1e04","_type":"span","marks":[],"text":"Alt som gjenstår nå er å bruke queryen vår"}],"markDefs":[],"style":"normal"},{"_key":"01a09a625fcb","_type":"code","code":"// file: todo.tsx\nimport {useState} from \"react\"\nimport {\n  addItemToTodo,\n  removeItemFromTodo,\n  toggleTodo,\n  useTodos,\n} from \"todoQuery\"\nimport { useQueryClient } from \"@tanstack/react-query\";\n\nexport default function TodoComponent(){\n  const todos = useTodos()\n  const [addTodo, setAddTodo] = useState\u003cString\u003e(\"\")\n   const queryClient = useQueryClient();\n  if (todos.isSuccess){\n    \u003c\u003e\n    \u003ch1\u003eMY TODOS\u003c/h1\u003e\n    \u003cinput type=\"text\" value={addTodo} onChange={(e) =\u003e {\n      setAddTodo(e.target.value)\n    }} /\u003e\n    \u003cbutton onClick={() =\u003e {\n      addItemToTodo(\n        {\n          description: addTodo,\n          done: false\n        }, queryClient)\n    }}\u003eAdd the todo\u003c/button\u003e\n    \u003cul\u003e\n      todos.data.items.map(todo =\u003e {\n        \u003cli\u003e\n          {todo.description}{\" \"}\n          {todo.done ? \"done\": \"not done\"}\n          \u003cbutton onClick={() =\u003e {\n            toggleTodo(todo.id, queryClient)\n          }}\u003etoggle todo\u003c/button\u003e\n          \u003cbuttononClick={() =\u003e {\n            removeItemFromTodo(todo.id, queryClient)\n          }}\u003eremove todo \u003c/button\u003e\n        \u003c/li\u003e\n      })\n    \u003c/ul\u003e\n    \u003c/\u003e\n  } else {\n    \u003ch1\u003eLaster inn ...\u003c/h1\u003e\n  }\n}","language":"typescript"},{"_key":"482257bf6030","_type":"block","children":[{"_key":"ebb692ea0974","_type":"span","marks":[],"text":"Queryen fungerer nå på tvers av faner!!!"}],"markDefs":[],"style":"normal"}],"cudoz":[{"image":{"_type":"image","asset":{"_ref":"image-0ecb68d017f70ab26cde2f8642dfd8072944ab10-516x518-png","_type":"reference"}},"links":["https://no.linkedin.com/in/carlo-morte-92a687131"],"name":"Carlo Morte"}],"ikiId":"a39fc5cc-77a4-4756-8674-a69f3ed733db","slug":"localevent","tittel":"Localstorage eventlistener"}},"__N_SSG":true},"page":"/post/[slug]","query":{"slug":"localevent"},"buildId":"EFLsK_tY0a_KvU_iVAZh1","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>